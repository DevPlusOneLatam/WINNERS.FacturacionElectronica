CREATE PROCEDURE IDC_FE_EXTRACCION_IMPUESTO
( @ObjType varchar(15), @DocEntry int )
AS BEGIN

DECLARE @ML nvarchar(3);
	
SELECT TOP 1 @ML = T0."MainCurncy" 
FROM OADM T0 INNER JOIN ADM1 T1 ON T0."Code" = T1."Code";

SELECT 
MAX(TT.FE_ID) "FE_ID",
MAX(TT.FE_IMPUESTOID) "FE_IMPUESTOID",
MAX(TT.FE_PORCENTAJE) "FE_PORCENTAJE",
SUM(TT.FE_MONTO) "FE_MONTO",
TT.FE_TIPO_TRIBUTO "FE_TIPO_TRIBUTO",
MAX(TT.FE_NOMBRE) "FE_NOMBRE",
SUM(TT.FE_VALOR_VENTA) "FE_VALOR_VENTA",
MAX(TT.FE_ABREVIATURA) "FE_ABREVIATURA",
MAX(TT.FE_CODIGO) "FE_CODIGO",
'' "FE_TIPO_AFECTACION",
TT.FE_MONEDA "FE_MONEDA" 

FROM

(

SELECT 
T3.U_BPP_MDTD+T3.U_BPP_MDSD+'-'+RIGHT('00000000' + Ltrim(Rtrim(RIGHT('00000000' + Ltrim(Rtrim(T3.U_BPP_MDCD)),8))),8)  AS"FE_ID",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN '1000'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN '9996'
	WHEN T2."U_IDC_TAFE"='20' THEN '9997'
	WHEN T2."U_IDC_TAFE"='21' THEN '9997'
	WHEN T2."U_IDC_TAFE"='30' THEN '9998'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36')THEN  '9996'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN '9995'
END "FE_IMPUESTOID",
(SELECT T0."ISOCurrCod" FROM OCRN T0 WHERE T0."CurrCode" = T3."DocCur") "FE_MONEDA",
SUM(CASE T3."DocCur" WHEN @ML THEN T2.LineTotal   ELSE TotalFrgn  END) "FE_VALOR_VENTA",
CASE WHEN T2."U_IDC_TAFE" IN ('10','20','30','40') THEN T1."Rate" ELSE 0 END "FE_PORCENTAJE",
ISNULL((CASE WHEN T2."U_IDC_TAFE" IN ('10','11','12','13','14','15','16','17','20','30','40') THEN  SUM ( CASE T3."DocCur" WHEN @ML THEN (T2.PriceAfVAT*T2.Quantity)-(T2.Price*T2.Quantity) ELSE (T2.PriceAfVAT*T2.Quantity)-(T2.Price*T2.Quantity) END) ELSE 0 END),0)  FE_MONTO,
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN '1000'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN '9996'
	WHEN T2."U_IDC_TAFE"='20' THEN '9997'
	WHEN T2."U_IDC_TAFE"='21' THEN '9997'
	WHEN T2."U_IDC_TAFE"='30' THEN '9998'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN '9996'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN '9995'
END "FE_TIPO_TRIBUTO",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'IGV'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'GRA'
	WHEN T2."U_IDC_TAFE"='20' THEN 'EXO'
	WHEN T2."U_IDC_TAFE"='21' THEN 'EXO'
	WHEN T2."U_IDC_TAFE"='30' THEN 'INA'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN 'GRA'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'EXP'
END "FE_NOMBRE",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'VAT'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'FRE'
	WHEN T2."U_IDC_TAFE"='20' THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='21' THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='30' THEN 'FRE'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36')THEN 'FRE'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'FRE'
END "FE_ABREVIATURA",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'S'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'Z'
	WHEN T2."U_IDC_TAFE"='20' THEN 'E'
	WHEN T2."U_IDC_TAFE"='21' THEN 'E'
	WHEN T2."U_IDC_TAFE"='30' THEN 'O'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN 'Z'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'G'
END "FE_CODIGO",
'' "FE_TIPO_AFECTACION"
FROM INV4 T0 
LEFT JOIN OSTA T1 ON T0."StaCode" = T1."Code"				 
LEFT JOIN OINV T3 ON T3."DocEntry" = T0."DocEntry"
LEFT JOIN INV1 T2 ON T0."DocEntry" = T2."DocEntry" AND T0."LineNum" = T2."LineNum" AND T0."RelateType" IN (1,2,3) 
LEFT JOIN OCRD T4 ON T3."CardCode" = T4."CardCode" 
WHERE
T0."DocEntry" = @docentry  and T3."ObjType" = @ObjType AND T2."LineNum" IS NOT NULL AND T2."TreeType"<>'I'
GROUP BY T3."DocCur",T1."Rate",T2."U_IDC_TAFE",T4.U_BPP_BPTP,T3.U_BPP_MDTD,T3.U_BPP_MDSD,RIGHT('00000000' + Ltrim(Rtrim(T3.U_BPP_MDCD)),8)


UNION ALL

SELECT 
T3.U_BPP_MDTD+T3.U_BPP_MDSD+'-'+RIGHT('00000000' + Ltrim(Rtrim(T3.U_BPP_MDCD)),8) AS"FE_ID",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN '1000'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN '1000'
	WHEN T2."U_IDC_TAFE"='20' THEN '9997'
	WHEN T2."U_IDC_TAFE"='21' THEN '9997'
	WHEN T2."U_IDC_TAFE"='30' THEN '9998'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36')THEN  '9996'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN '9995'
END "FE_IMPUESTOID",
(SELECT T0."ISOCurrCod" FROM OCRN T0 WHERE T0."CurrCode" = T3."DocCur") "FE_MONEDA",
SUM(CASE T3."DocCur" WHEN @ML THEN T2.LineTotal   ELSE TotalFrgn  END) "FE_VALOR_VENTA",
CASE WHEN T2."U_IDC_TAFE" IN ('10','20','30','40') THEN T1."Rate" ELSE 0 END "FE_PORCENTAJE",
ISNULL((CASE WHEN T2."U_IDC_TAFE" IN ('10','11','12','13','14','15','16','17','20','30','40') THEN  SUM ( CASE T3."DocCur" WHEN @ML THEN (T2.PriceAfVAT*T2.Quantity)-(T2.Price*T2.Quantity) ELSE (T2.PriceAfVAT*T2.Quantity)-(T2.Price*T2.Quantity) END) ELSE 0 END),0)  FE_MONTO,
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN '1000'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN '1000'
	WHEN T2."U_IDC_TAFE"='20' THEN '9997'
	WHEN T2."U_IDC_TAFE"='21' THEN '9997'
	WHEN T2."U_IDC_TAFE"='30' THEN '9998'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN '9996'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN '9995'
END "FE_TIPO_TRIBUTO",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'IGV'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'IGV'
	WHEN T2."U_IDC_TAFE"='20' THEN 'EXO'
	WHEN T2."U_IDC_TAFE"='21' THEN 'EXO'
	WHEN T2."U_IDC_TAFE"='30' THEN 'INA'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN 'GRA'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'EXP'
END "FE_NOMBRE",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'VAT'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='20' THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='21' THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='30' THEN 'FRE'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36')THEN 'FRE'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'FRE'
END "FE_ABREVIATURA",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'S'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'S'
	WHEN T2."U_IDC_TAFE"='20' THEN 'E'
	WHEN T2."U_IDC_TAFE"='21' THEN 'E'
	WHEN T2."U_IDC_TAFE"='30' THEN 'O'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN 'Z'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'G'
END "FE_CODIGO",
'' "FE_TIPO_AFECTACION"
FROM RIN4 T0 
LEFT JOIN OSTA T1 ON T0."StaCode" = T1."Code"				 
LEFT JOIN ORIN T3 ON T3."DocEntry" = T0."DocEntry"
LEFT JOIN RIN1 T2 ON T0."DocEntry" = T2."DocEntry" AND T0."LineNum" = T2."LineNum" AND T0."RelateType" IN (1,2,3) 
LEFT JOIN OCRD T4 ON T3."CardCode" = T4."CardCode" 
WHERE
T0."DocEntry" = @docentry  and T3."ObjType" = @ObjType AND T2."LineNum" IS NOT NULL AND T2."TreeType"<>'I'
GROUP BY T3."DocCur",T1."Rate",T2."U_IDC_TAFE",T4.U_BPP_BPTP,T3.U_BPP_MDTD,T3.U_BPP_MDSD,RIGHT('00000000' + Ltrim(Rtrim(T3.U_BPP_MDCD)),8)

UNION ALL

SELECT 
T3.U_BPP_MDTD+T3.U_BPP_MDSD+'-'+RIGHT('00000000' + Ltrim(Rtrim(T3.U_BPP_MDCD)),8) AS"FE_ID",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN '1000'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN '1000'
	WHEN T2."U_IDC_TAFE"='20' THEN '9997'
	WHEN T2."U_IDC_TAFE"='21' THEN '9997'
	WHEN T2."U_IDC_TAFE"='30' THEN '9998'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36')THEN  '9996'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN '9995'
END "FE_IMPUESTOID",
(SELECT T0."ISOCurrCod" FROM OCRN T0 WHERE T0."CurrCode" = T3."DocCur") "FE_MONEDA",
SUM(CASE T3."DocCur" WHEN @ML THEN T2.LineTotal   ELSE TotalFrgn  END) "FE_VALOR_VENTA",
CASE WHEN T2."U_IDC_TAFE" IN ('10','20','30','40') THEN T1."Rate" ELSE 0 END "FE_PORCENTAJE",
ISNULL((CASE WHEN T2."U_IDC_TAFE" IN ('10','11','12','13','14','15','16','17','20','30','40') THEN  SUM ( CASE T3."DocCur" WHEN @ML THEN (T2.PriceAfVAT*T2.Quantity)-(T2.Price*T2.Quantity) ELSE (T2.PriceAfVAT*T2.Quantity)-(T2.Price*T2.Quantity) END) ELSE 0 END),0)  FE_MONTO,
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN '1000'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN '1000'
	WHEN T2."U_IDC_TAFE"='20' THEN '9997'
	WHEN T2."U_IDC_TAFE"='21' THEN '9997'
	WHEN T2."U_IDC_TAFE"='30' THEN '9998'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN '9996'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN '9995'
END "FE_TIPO_TRIBUTO",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'IGV'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'IGV'
	WHEN T2."U_IDC_TAFE"='20' THEN 'EXO'
	WHEN T2."U_IDC_TAFE"='21' THEN 'EXO'
	WHEN T2."U_IDC_TAFE"='30' THEN 'INA'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN 'GRA'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'EXP'
END "FE_NOMBRE",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'VAT'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='20' THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='21' THEN 'VAT'
	WHEN T2."U_IDC_TAFE"='30' THEN 'FRE'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36')THEN 'FRE'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'FRE'
END "FE_ABREVIATURA",
CASE 
	WHEN T2."U_IDC_TAFE"='10' THEN 'S'
	WHEN T2."U_IDC_TAFE" IN ('11','12','13','14','15','16','17')  THEN 'S'
	WHEN T2."U_IDC_TAFE"='20' THEN 'E'
	WHEN T2."U_IDC_TAFE"='21' THEN 'E'
	WHEN T2."U_IDC_TAFE"='30' THEN 'O'
	WHEN T2."U_IDC_TAFE" IN ('31','32','33','34','35','36') THEN 'Z'
	WHEN T2."U_IDC_TAFE"='40' AND T4.U_BPP_BPTP='SND' THEN 'G'
END "FE_CODIGO",
'' "FE_TIPO_AFECTACION"
FROM DPI4 T0 
LEFT JOIN OSTA T1 ON T0."StaCode" = T1."Code"				 
LEFT JOIN ODPI T3 ON T3."DocEntry" = T0."DocEntry"
LEFT JOIN DPI1 T2 ON T0."DocEntry" = T2."DocEntry" AND T0."LineNum" = T2."LineNum" AND T0."RelateType" IN (1,2,3) 
LEFT JOIN OCRD T4 ON T3."CardCode" = T4."CardCode" 
WHERE
T0."DocEntry" = @docentry  and T3."ObjType" = @ObjType AND T2."LineNum" IS NOT NULL AND T2."TreeType"<>'I'
GROUP BY T3."DocCur",T1."Rate",T2."U_IDC_TAFE",T4.U_BPP_BPTP,T3.U_BPP_MDTD,T3.U_BPP_MDSD,RIGHT('00000000' + Ltrim(Rtrim(T3.U_BPP_MDCD)),8)

) TT GROUP BY TT.FE_TIPO_TRIBUTO ,TT.FE_MONEDA ;





END